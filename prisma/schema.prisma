generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model VehicleImage {
  id            Int    @id @default(autoincrement())
  vehicle_id    Int?
  image_url     String
  vehicle       Vehicle?   @relation("VehicleToVehicleImages", fields: [vehicle_id], references: [id], onDelete: Cascade)

  @@map("car_images")
}

model Extra {
  id             Int            @id @default(autoincrement())
  name           String         @db.VarChar(100)
  total_quantity Int // Total quantity of the extra
  description    String?
  price_type     String?        @db.VarChar(50) // e.g., "per day", "per booking"
  price_amount   Int? // Amount charged for the extra
  bookingExtras  BookingExtra[] // Relation to BookingExtras

  @@map("extras")
}

model BookingExtra {
  id         Int     @id @default(autoincrement())
  booking_id Int
  extra_id   Int
  extra_name String?
  quantity   Int // Quantity of extras booked for the given period
  booking    Booking @relation(fields: [booking_id], references: [id], onDelete: Cascade)
  extra      Extra   @relation(fields: [extra_id], references: [id], onDelete: Cascade)

  @@unique([booking_id, extra_id]) // Ensure no duplicate extras per booking
}

model Booking {
  id                   Int            @id @default(autoincrement())
  vehicle_id           Int?
  user_id              Int?
  start_date           DateTime       @db.Timestamp(6)
  end_date             DateTime       @db.Timestamp(6)
  status               String?        @default("active") @db.VarChar(20) // Booking status (e.g., "active", "cancelled")
  total_price          Decimal?       @db.Decimal(10, 2)
  
  // PayPal-related fields
  paypal_order_id      String?        @db.VarChar(100) // PayPal Order ID
  paypal_transaction_id String?       @db.VarChar(100) // PayPal Transaction ID
  payment_provider     String?        @default("paypal") @db.VarChar(50) // Payment provider
  currency             String         @default("USD") @db.VarChar(3) // Currency used in the transaction
  is_paid              Boolean        @default(false) // Whether the booking has been fully paid
  
  created_at           DateTime?      @default(now()) @db.Timestamp(6)
  updated_at           DateTime?      @default(now()) @updatedAt @db.Timestamp(6)

  // Relations
  bookingExtras        BookingExtra[]
  vehicle              Vehicle?        @relation(fields: [vehicle_id], references: [id], onDelete: Cascade)
  user                 User?          @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([start_date, end_date]) // Index for optimizing availability checks
}

model Vehicle {
  id                Int        @id @default(autoincrement())
  mpg               Decimal?   @db.Decimal(5, 2)
  gas_type          String?    @db.VarChar(50)
  num_doors         Int?
  num_seats         Int?
  short_description String?
  long_description  String?
  features          String?
  extras            String?
  guidelines        String?
  faqs              Json?
  price             Decimal    @db.Decimal(10, 2)
  turo_url          String?
  make              String?    @db.VarChar(100)
  model             String?    @db.VarChar(100)
  year              Int?
  type              String?    @db.VarChar(50)
  bookings          Booking[]
  vehicleImages     VehicleImage[] @relation("VehicleToVehicleImages")
  deleted_at        DateTime? // Soft delete field

  @@map("cars")
}

model User {
  id                   Int       @id @default(autoincrement())
  email                String    @unique @db.VarChar(100)
  password_hash        String    @db.VarChar(100)
  full_name            String?   @db.VarChar(100)
  date_of_birth        DateTime?
  role_access          String?   @db.VarChar(10)
  phone                String?   @db.VarChar(20)
  street_address       String?   @db.Text
  zip_code             String?   @db.VarChar(10)
  country              String?   @db.VarChar(3)

  // License Information
  license_number       String    @db.VarChar(25)
  license_state        String    @db.VarChar(25)
  license_front_img    String    @db.Text
  license_back_img     String    @db.Text
  license_expiration   DateTime

  // PayPal-related fields for payment
  paypal_payer_id      String?   @db.VarChar(100) // Unique PayPal payer ID for identifying the PayPal account
  paypal_billing_agreement_id String? @db.VarChar(100) // PayPal billing agreement ID for saved payment methods
  paypal_payment_token String?   @db.VarChar(100) // Token used for recurring payments or stored payment methods

  // Billing Information
  billing_full_name      String? @db.VarChar(100)
  billing_street_address String? @db.Text
  billing_city           String? @db.VarChar(50)
  billing_state          String? @db.VarChar(50)
  billing_country        String? @db.VarChar(3)
  billing_postal_code    String? @db.VarChar(10)

  // Optionally, if tax data is required
  tax_id        String? @db.VarChar(50)
  billing_email String? @db.VarChar(100)

  bookings       Booking[]
  created_at     DateTime? @default(now()) @db.Timestamp(6)
  updated_at     DateTime? @updatedAt @db.Timestamp(6)
  deleted_at     DateTime? // Soft delete field

  @@map("users")
}

