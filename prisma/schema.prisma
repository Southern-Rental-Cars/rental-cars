generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model Booking {
  id                    String         @id @default(uuid())
  user_id               String
  vehicle_id            Int
  start_date            DateTime       @db.Timestamp(6)
  end_date              DateTime       @db.Timestamp(6)
  total_price           Decimal        @db.Decimal(10, 2)
  currency              String         @default("USD") @db.VarChar(3)
  is_paid               Boolean        @default(false)

  payment_provider      String?        @default("paypal") @db.VarChar(50)
  paypal_order_id       String?        @db.VarChar(100)
  paypal_transaction_id String?        @db.VarChar(100)

  delivery_required     Boolean        @default(false) // New field
  delivery_type         String?        @db.VarChar(50) // "local" or "IAH" for airport
  delivery_address      String?        @db.VarChar(255) // New field for storing the delivery address

  vehicle               Vehicle?       @relation(fields: [vehicle_id], references: [id], onDelete: Cascade)

  bookingExtras         BookingExtra[]

  created_at            DateTime?      @default(now()) @db.Timestamp(6)
  updated_at            DateTime?      @default(now()) @updatedAt @db.Timestamp(6)

  @@index([start_date, end_date])
}

model Extra {
  id             Int            @id @default(autoincrement())
  name           String         @db.VarChar(100)
  description    String?
  price_type     String?        @db.VarChar(50)
  price_amount   Int?
  total_quantity Int?
  
  bookingExtras  BookingExtra[]
  
  // Many-to-many relationship with Vehicle
  vehicles       Vehicle[]      @relation("VehicleExtras")

  @@map("extras")
}

model BookingExtra {
  id         String    @id @default(uuid())
  booking_id String
  extra_id   Int
  extra_name String?
  quantity   Int

  booking    Booking @relation(fields: [booking_id], references: [id], onDelete: Cascade)
  extra      Extra   @relation(fields: [extra_id], references: [id], onDelete: Cascade)

  @@unique([booking_id, extra_id])
}

model Vehicle {
  id                Int            @id @default(autoincrement())
  make              String?        @db.VarChar(100)
  model             String?        @db.VarChar(100)
  mpg               Decimal?       @db.Decimal(5, 2)
  gas_type          String?        @db.VarChar(50)
  num_doors         Int?
  num_seats         Int?
  short_description String?
  year              Int?
  type              String?        @db.VarChar(50)
  guidelines        String?
  faqs              Json?
  features          String?
  thumbnail         String         @db.Text
  price             Decimal        @db.Decimal(10, 2)

  // Relations
  bookings          Booking[]
  extras            Extra[]        @relation("VehicleExtras") // Many-to-many relationship with Extra

  deleted_at        DateTime?

  @@map("cars")
}

model VehicleImage {
  id         Int     @id @default(autoincrement())
  vehicle_id Int    // Stores the ID of the related vehicle
  image_url  String

  @@map("car_images")
}

enum Role {
  customer
  admin
}

model User {
  id                   String    @id @default(uuid())
  role_access          Role      @default(customer) // Enum for role_access
  email                String    @unique @db.VarChar(100)
  password_hash        String    @db.VarChar(100)
  full_name            String?   @db.VarChar(100)
  date_of_birth        DateTime?
  phone                String?   @db.VarChar(20)
  street_address       String?   @db.Text
  zip_code             String?   @db.VarChar(10)

  // License Information
  license_number       String?    @db.VarChar(25)
  license_state        String?    @db.VarChar(25)
  license_city         String?    @db.VarChar(25)
  license_country      String?    @db.VarChar(25)
  license_expiration   DateTime?
  license_front_img    String?    @db.Text
  license_back_img     String?    @db.Text

  // PayPal-related fields for payment
  paypal_payer_id             String?   @db.VarChar(100) // Unique PayPal payer ID for identifying the PayPal account
  paypal_billing_agreement_id String?   @db.VarChar(100) // PayPal billing agreement ID for saved payment methods
  paypal_payment_token        String?   @db.VarChar(100) // Token used for recurring payments or stored payment methods

  // Billing Information
  billing_street_address String? @db.Text
  billing_city           String? @db.VarChar(50)
  billing_state          String? @db.VarChar(50)
  billing_postal_code    String? @db.VarChar(10)
  billing_country        String? @db.VarChar(3)

  created_at             DateTime? @default(now()) @db.Timestamp(6)
  updated_at             DateTime? @updatedAt @db.Timestamp(6)
  deleted_at             DateTime? 

  @@map("users")
}

model VerificationCode {
  id          String   @id @default(uuid())
  code        String   @db.VarChar(6)
  email       String   @unique @db.VarChar(100)
  expires_at  DateTime
  
  @@index([email, code, expires_at])
  @@map("verification_codes")
}

